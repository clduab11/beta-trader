# Notion Spec to Linear Sync
# ------------------------------------------------------------------
# Trigger: Manual or Repository Dispatch (from Notion Webhook)
# Purpose: Converts a finalized Notion Spec -> Linear Epic + Issues
# Source of Truth: Notion (Spec)
# Execution: Linear (Tickets)

name: Notion Spec to Linear

on:
  repository_dispatch:
    types: [notion-spec-finalized]
  workflow_dispatch:
    inputs:
      notion_page_id:
        description: "Notion Page ID of the Spec"
        required: true
        type: string
      linear_team_key:
        description: "Linear Team Key (e.g. PAR)"
        required: true
        default: "PAR"
        type: string

env:
  LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
  NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}

jobs:
  sync:
    name: Sync Spec to Linear
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install @notionhq/client @linear/sdk

      - name: Parse Spec and Create Issues
        uses: actions/github-script@v7
        with:
          script: |
            const { Client } = require('@notionhq/client');
            const { LinearClient } = require('@linear/sdk');
            
            const notion = new Client({ auth: process.env.NOTION_API_KEY });
            const linear = new LinearClient({ apiKey: process.env.LINEAR_API_KEY });
            
            const pageId = context.payload.inputs ? context.payload.inputs.notion_page_id : context.payload.client_payload.notion_page_id;
            const teamKey = context.payload.inputs ? context.payload.inputs.linear_team_key : "PAR";

            if (!pageId) throw new Error("No Notion Page ID provided");

            // 1. Fetch Notion Page (Title)
            const page = await notion.pages.retrieve({ page_id: pageId });
            const title = page.properties.Name?.title?.[0]?.plain_text || "Untitled Spec";
            const url = page.url;

            console.log(`Processing Spec: ${title}`);

            // 2. Fetch Team
            const teams = await linear.teams({ filter: { key: { eq: teamKey } } });
            const team = teams.nodes[0];
            if (!team) throw new Error(`Team ${teamKey} not found`);

            // 3. Create Epic
            const epic = await linear.createEpic({
              name: title,
              description: `Spec Source: ${url}`,
              teamId: team.id
            });
            const epicId = (await epic.epic).id;
            console.log(`Created Epic: ${title} (${epicId})`);

            // 4. Fetch Blocks (Tasks)
            const blocks = await notion.blocks.children.list({ block_id: pageId });
            
            // Simple logic: Find non-checked To-do blocks
            for (const block of blocks.results) {
              if (block.type === 'to_do' && !block.to_do.checked) {
                const taskTitle = block.to_do.rich_text.map(t => t.plain_text).join('');
                if (!taskTitle) continue;

                await linear.createIssue({
                  teamId: team.id,
                  title: taskTitle,
                  description: `From Notion Spec: ${url}`,
                  epicId: epicId
                });
                console.log(`- Created Issue: ${taskTitle}`);
              }
            }
